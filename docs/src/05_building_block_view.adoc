
[[section-building-block-view]]
== Building Block View

This section describes the static decomposition of the YOVI system into building blocks. Following arc42 guidelines,
we present a **hierarchical view**:

* **Level 1**: White box description of the overall system, with black box descriptions of each top-level building block
* **Level 2**: White box descriptions of selected building blocks, showing their internal structure

This abstraction allows understanding the system structure without drowning in implementation details.

=== Level 1: Overall System White Box

The YOVI system is decomposed into **four top-level building blocks**: three services and an API gateway, plus an external database.

[plantuml,"Level 1 System White Box",png]
----
@startuml
!define RECTANGLE node

skinparam componentStyle rectangle
skinparam backgroundColor #FEFEFE

package "YOVI System (Level 1)" {

  component "API Gateway (gateway/)" as Gateway <<gateway>>

  component "Web Frontend Service (webapp/)" as Webapp <<frontend>>

  component "User Service (users/)" as Users <<backend>>

  component "Game Engine Service (gamey/)" as Gamey <<backend>>

  database "MongoDB (database)" as DB <<database>>

  Gateway --> Webapp : "serves static files\n(HTTP)"
  Gateway --> Users : "routes /api/users/*\n(HTTP)"
  Gateway --> Gamey : "routes /api/game/*\n(HTTP)"

  Users --> DB : "MongoDB Wire Protocol\n(persistence)"

  Webapp --> Gateway : "API calls to backend\n(HTTP, internal)"

  note top of Gateway
    **Provided Interfaces:**
    * Public Web UI (port 443)
    * Public Bot API (port 443)
    **Responsibilities:**
    * SSL termination
    * Request routing
    * Rate limiting
  end note

  note bottom of Webapp
    **Provided:**
    * Web UI for humans
    **Required:**
    * User Service API
    * Game Engine API
  end note

  note bottom of Users
    **Provided:**
    * User Management API
    **Required:**
    * MongoDB
  end note

  note bottom of Gamey
    **Provided:**
    * Game Logic API (YEN)
    * Bot Strategy API
    **Required:**
    * None
  end note
}

actor "Human Player" as Human
actor "External Bot" as Bot

Human --> Gateway : "HTTPS"
Bot --> Gateway : "HTTPS (API calls)"

@enduml
----

==== Black Box Descriptions

===== API Gateway

* **Purpose/Responsibility**: Acts as the single entry point to the system. Routes external requests to the appropriate internal service, handles SSL termination, and provides a security layer.
* **Interface(s)**:
** *Provided*:
*** Public Web UI endpoint
*** Public Bot API endpoint
** *Required*:
*** Web Frontend Service (internal HTTP)
*** User Service (internal HTTP)
*** Game Engine Service (internal HTTP)
* **Quality/Performance Characteristics**: Must handle all external traffic; availability is critical. Stateless, can be scaled horizontally.
* **Directory/File Location**: `/gateway/` (nginx config or Express Gateway config)
* **Fulfilled Requirements**: Public deployment, single entry point
* **Open Issues**: SSL certificate management in production

===== Web Frontend Service

* **Purpose/Responsibility**: Provides the user interface for human players. Handles game rendering, user interaction, and orchestrates calls to backend services.
* **Interface(s)**:
** *Provided*: Web UI (HTML/CSS/JS) served to browsers
** *Required*:
*** User Service API
*** Game Engine API
* **Quality/Performance Characteristics**: Responsive UI (< 100ms for interactions). Must support i18n. Stateless for scalability.
* **Directory/File Location**: `/webapp/` (React + TypeScript source)
* **Fulfilled Requirements**: Web frontend, game visualization, strategy selection UI
* **Open Issues**: Real-time updates for future multiplayer features

===== User Service

* **Purpose/Responsibility**: Manages all user-related data: registration, authentication, profile information, match history, and statistics.
* **Interface(s)**:
** *Provided*: REST API  with endpoints for register, login, profile, stats
** *Required*: MongoDB for data persistence
* **Quality/Performance Characteristics**: Must persist data reliably. Response time < 200ms for typical operations.
* **Directory/File Location**: `/users/` (Node.js + Express)
* **Fulfilled Requirements**: User registration, match history, statistics
* **Open Issues**: Authentication token expiration and refresh strategy

===== Game Engine Service

* **Purpose/Responsibility**: Encapsulates all Game Y logic: move validation, win condition checking, and AI move calculation with multiple strategies.
* **Interface(s)**:
** *Provided*: REST API (`/api/game/*`) using YEN notation for game states
** *Required*: None (stateless, no external dependencies)
* **Quality/Performance Characteristics**: Low latency (< 500ms for move calculation). High correctness (100% rule compliance). Memory safety critical.
* **Directory/File Location**: `/gamey/` (Rust)
* **Fulfilled Requirements**: Game rule verification, AI move suggestion, multiple strategies, YEN notation
* **Open Issues**: Performance optimization for large boards

===== MongoDB Database

* **Purpose/Responsibility**: Persists user data, including profiles, authentication credentials, match history, and statistics.
* **Interface(s)**:
** *Provided*: MongoDB Wire Protocol
** *Required*: None (data storage only)
* **Quality/Performance Characteristics**: Durable storage, backup capability. Must handle concurrent connections.
* **Directory/File Location**: Managed via Docker (not in repo)
* **Fulfilled Requirements**: User data persistence
* **Open Issues**: Backup and recovery strategy

=== Level 2: Building Block Internals

==== White Box: Web Frontend Service (`webapp/`)

The web frontend is structured following a **component-based architecture** with clear separation of concerns.

[plantuml,"Webapp Internal Structure",png]
----
@startuml
!define RECTANGLE component

package "Web Frontend Service (Level 2)" {

  component "UI Components (React)" as UI <<frontend>>

  component "State Management (Context/Redux)" as State <<frontend>>

  component "API Client (axios)" as APIClient <<frontend>>

  component "Routing (React Router)" as Router <<frontend>>

  component "i18n Module" as I18n <<frontend>>

  UI --> State : "reads/updates"
  UI --> Router : "navigation"
  UI --> I18n : "translations"

  State --> APIClient : "fetches data"

  APIClient --> "External Services" : "HTTP calls"

  note right of UI
    **Contained Building Blocks:**
    * GameBoard
    * RegisterForm
    * UserProfile
  end note
}

@enduml
----

===== Black Box Descriptions (Webapp Internals) (In development)

|===
| Building Block | Responsibility | Key Interfaces | Location
| **UI Components** | Render all user interfaces; handle user input events | Props/State callbacks | `webapp/src/components/`
| **State Management** | Maintain application state (user, game, UI) | Context API / Redux store | `webapp/src/store/`
| **API Client** | Communicate with backend services | HTTP methods (GET, POST) | `webapp/src/services/`
| **Routing** | Handle navigation between views | URL paths | `webapp/src/routes/`
| **i18n Module** | Provide internationalization support | Translation keys → strings | `webapp/src/i18n/`
|===

==== White Box: Game Engine Service (`gamey/`)

The game engine is structured in layers, with clear separation between parsing, core logic, and AI strategies.

[plantuml,"Game Engine Internal Structure",png]
----
@startuml
!define RECTANGLE component

package "Game Engine Service (Level 2)" {

  component "HTTP Server (web/)" as HTTP <<backend>>

  component "YEN Parser (notation/)" as Parser <<backend>>

  component "Game Core (core/)" as Core <<backend>>

  component "AI Strategies (bot/)" as AI <<backend>>

  component "Board Model (core/board)" as Board <<backend>>

  HTTP --> Parser : "parse YEN"
  Parser --> Core : "validated game state"
  Core --> Board : "manipulates"
  Core --> AI : "requests move"
  AI --> Core : "returns move"



  note right of AI
    **Strategies:**
    * Random (implemented)
    * Heuristic (discussing)
    * Minimax (discussing)
  end note
}

@enduml
----

===== Black Box Descriptions (Game Engine Internals)

|===
| Building Block | Responsibility | Key Interfaces | Location
| **HTTP Server** | Expose REST endpoints; handle requests/responses | `POST /move`, `GET /strategies` | `gamey/src/web/`
| **YEN Parser** | Parse and validate YEN notation; serialize to YEN | `parse()`, `serialize()` | `gamey/src/notation/`
| **Game Core** | Implement Game Y rules; validate moves; check wins | `apply_move()`, `is_game_over()` | `gamey/src/core/`
| **Board Model** | Represent board state; manage cells | `get_cell()`, `set_cell()` | `gamey/src/core/board.rs`
| **AI Strategies** | Implement different bot behaviors | `calculate_move()` (trait) | `gamey/src/bot/`
|===

==== White Box: User Service (`users/`)

The user service follows a typical **layered architecture** for REST APIs.

[plantuml,"User Service Internal Structure",png]
----
@startuml
!define RECTANGLE component

package "User Service (Level 2)" {

  component "API Routes (routes/)" as Routes <<backend>>

  component "Controllers (controllers/)" as Controllers <<backend>>

  component "Services (services/)" as Services <<backend>>

  component "Repositories (repositories/)" as Repos <<backend>>

  component "Models (models/)" as Models <<backend>>

  Routes --> Controllers : "route → controller"
  Controllers --> Services : "business logic"
  Services --> Repos : "data access"
  Repos --> Models : "data mapping"
  Repos --> "MongoDB" : "database"

  note right of Routes
    **Endpoints:**
    * POST /register
    * POST /login
    * GET /profile/:id (in process)
    * GET /:id/stats (in process)
  end note
}

@enduml
----

===== Black Box Descriptions (User Service Internals) (In development)

|===
| Building Block | Responsibility | Key Interfaces | Location
| **API Routes** | Define HTTP endpoints and HTTP methods | Express route handlers | `users/src/routes/`
| **Controllers** | Handle requests, validate input, format responses | Controller functions | `users/src/controllers/`
| **Services** | Implement business logic (password hashing, etc.) | Service methods | `users/src/services/`
| **Repositories** | Abstract database operations | CRUD operations | `users/src/repositories/`
| **Models** | Define data schemas and validation | Mongoose schemas | `users/src/models/`
|===


=== Interface Overview

This table summarizes the key interfaces between building blocks, showing the **provided** and **required** relationships.

|===
| Interface | Provider | Consumer | Protocol | Data Format | Purpose
| **Public Web UI** | Gateway | Browser | HTTPS | HTML/CSS/JS | Serve frontend to users
| **Public Bot API** | Gateway | External Bot | HTTPS | JSON (YEN) | Bot integration
| **User API** | Users Service | Webapp | HTTP (internal) | JSON | User management
| **Game API** | Gamey Service | Webapp | HTTP (internal) | JSON (YEN) | Game logic
| **Database Interface** | MongoDB | Users Service | MongoDB Wire | BSON | Data persistence
| **Internal Gateway Calls** | Gateway | Webapp/Users/Gamey | HTTP (internal) | JSON | Service communication
|===

=== Mapping to Requirements

This table shows how the building blocks fulfill the key requirements from section 1.

|===
| Requirement | Primary Building Block | Supporting Building Blocks
| Web frontend (TypeScript/React) | Web Frontend Service | Gateway
| Rust game engine | Game Engine Service | (none)
| JSON + YEN communication | Game Engine Service | Webapp (client), Gateway (routing)
| Public API for bots | Gateway | Game Engine Service
| User registration | User Service | MongoDB
| Match history | User Service | MongoDB, Webapp (UI)
| Multiple AI strategies | Game Engine Service | (none)
| Docker deployment | All services | docker-compose
| CI/CD | GitHub Actions | All services
|===